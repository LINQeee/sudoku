<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–°–æ–≤–º–µ—Å—Ç–Ω–æ–µ –°—É–¥–æ–∫—É</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <button
      id="themeToggle"
      style="
        position: fixed;
        top: 20px;
        right: 20px;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--block-bg);
        color: var(--text-dark);
        cursor: pointer;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.2);
      "
    >
      üåì
    </button>
    <h1>–°–æ–≤–º–µ—Å—Ç–Ω–æ–µ –°—É–¥–æ–∫—É (Real-Time)</h1>

    <select id="difficulty">
      <option value="easy">–õ—ë–≥–∫–∞—è</option>
      <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
      <option value="hard">–°–ª–æ–∂–Ω–∞—è</option>
    </select>
    <button id="newGame">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>

    <div id="board"></div>

    <div id="numberPad"></div>

    <script>
      if (localStorage.getItem('theme') == 'dark')
        document.documentElement.classList.add('dark')
      const btn = document.getElementById('themeToggle')
      btn.onclick = () => {
        if (localStorage.getItem('theme') == 'dark')
          localStorage.setItem('theme', 'light')
        else localStorage.setItem('theme', 'dark')
        document.documentElement.classList.toggle('dark')
      }
      const ws = new WebSocket('ws://localhost:8080')

      let board = []
      let selectedCell = null
      let leftCount = Array(10).fill(9)

      ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data)

        if (data.type === 'state') renderBoard(data.board)

        if (data.type === 'update')
          updateCell(data.row, data.col, data.value, data.correct)
      }

      document.getElementById('newGame').onclick = () => {
        ws.send(JSON.stringify({ type: 'new', difficulty: difficulty.value }))
      }

      function sendUpdate(r, c, v) {
        ws.send(JSON.stringify({ type: 'update', row: r, col: c, value: v }))
      }

      const boardDiv = document.getElementById('board')

      function renderBoard(b) {
        board = b
        boardDiv.innerHTML = ''
        leftCount = Array(10).fill(9)

        const blocks = []
        for (let i = 0; i < 9; i++) {
          let block = document.createElement('div')
          block.classList.add('block')
          boardDiv.appendChild(block)
          blocks.push(block)
        }

        const appendToBlock = (r, c, cell) => {
          let i
          if (c < 3) {
            if (r < 3) i = 0
            else if (r > 2 && r < 6) i = 3
            else if (r > 5) i = 6
          } else if (c > 2 && c < 6) {
            if (r < 3) i = 1
            else if (r > 2 && r < 6) i = 4
            else if (r > 5) i = 7
          } else if (c > 5) {
            if (r < 3) i = 2
            else if (r > 2 && r < 6) i = 5
            else if (r > 5) i = 8
          }
          blocks[i].appendChild(cell)
        }

        for (let r = 0; r < 9; r++) {
          for (let c = 0; c < 9; c++) {
            const val = b[r][c].value
            if (val) leftCount[val]--

            const cell = document.createElement('div')
            cell.className = 'cell'

            if (c === 2 || c === 5) {
              cell.classList.add('block-right')
            }
            if (r === 2 || r === 5) cell.classList.add('block-bottom')

            if (b[r][c].fixed) cell.classList.add('fixed')
            else if (b[r][c].value) cell.classList.add('solved')

            cell.textContent = val || ''
            cell.dataset.r = r
            cell.dataset.c = c

            cell.onclick = () =>
              selectCell(r, c, b[r][c].fixed || b[r][c].solved)

            appendToBlock(r, c, cell)
          }
        }
        renderNumberPad()
      }

      function getCell(idx) {
        const r = Math.floor(idx / 9),
          c = idx % 9
        const blockIndex = Math.floor(r / 3) * 3 + Math.floor(c / 3)
        const cellIndex = (r % 3) * 3 + (c % 3)
        return boardDiv.children[blockIndex]?.children[cellIndex] ?? null
      }

      function updateCell(r, c, value, correct) {
        const idx = r * 9 + c
        const cell = getCell(idx)
        const old = board[r][c].value

        if (correct) {
          board[r][c].value = value
          board[r][c].fixed = true
          board[r][c].solved = true

          if (old) leftCount[old]++
          if (value) leftCount[value]--

          cell.textContent = value || ''
          cell.classList.remove('wrong')
          cell.classList.add('solved', 'pop')
          highlightSame(board[r][c].value)
          // setTimeout(() => cell.classList.remove('pop'), 350)
          // if (selectedCell && selectedCell.r === r && selectedCell.c === c) {
          //   selectedCell = null
          //   clearSelectionVisuals()
          // }
        } else {
          cell.textContent = value
          cell.classList.add('wrong')
          setTimeout(() => {
            if (cell && cell.classList) {
              cell.classList.remove('wrong')
              cell.textContent = board[r][c].value || ''
            }
          }, 1400)
        }

        renderNumberPad()
      }

      function selectCell(r, c, fixed) {
        if (fixed) {
          selectedCell = null
          clearSelectionVisuals()
          highlightSame(board[r][c].value)
          return
        }

        selectedCell = { r, c }
        clearSelectionVisuals()

        const idx = r * 9 + c
        const cell = getCell(idx)
        const isEmpty = !board[r][c].value

        cell.classList.add('selected')
        if (isEmpty) cell.classList.add('selected-empty')

        console.log(board[r][c].value)
        highlightSame(board[r][c].value)
      }

      function clearSelectionVisuals() {
        for (let i = 0; i < 81; i++) {
          getCell(i).classList.remove('selected', 'selected-empty')
          getCell(i).style.opacity = ''
        }
      }

      function highlightSame(num) {
        for (let i = 0; i < 81; i++) getCell(i).classList.remove('highlight')
        if (!num) return

        for (let r = 0; r < 9; r++)
          for (let c = 0; c < 9; c++) {
            if (board[r][c].value === num) {
              const idx = r * 9 + c
              if (getCell(idx).textContent != num) continue
              getCell(idx).classList.add('highlight')
            }
          }
      }

      const pad = document.getElementById('numberPad')
      function renderNumberPad() {
        pad.innerHTML = ''
        for (let n = 1; n <= 9; n++) {
          const btn = document.createElement('button')
          btn.className = 'num-btn'
          btn.innerHTML = `<span>${n}</span><small>${leftCount[n]}</small>`
          btn.disabled = leftCount[n] <= 0

          // –ø—Ä–∏ –∫–ª–∏–∫–µ: —Å—Ç–∞–≤–∏–º –∞–∫—Ç–∏–≤–Ω—ã–π –≤–∏–∑—É–∞–ª, –≤—ã–∑—ã–≤–∞–µ–º placeNumber –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —á–∏—Å–ª–∞
          btn.onclick = () => {
            // –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤–∏–∑—É–∞–ª—å–Ω–æ –Ω–∞ 700ms
            btn.classList.add('active')
            setTimeout(() => btn.classList.remove('active'), 700)

            // UX: –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∞–∫–∏—Ö —á–∏—Å–µ–ª (–Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ)
            if (!selectedCell) highlightSame(n)

            placeNumber(n)
          }
          pad.appendChild(btn)
        }
      }

      function placeNumber(n) {
        if (!selectedCell) return
        const { r, c } = selectedCell
        if (board[r][c].fixed || board[r][c].solved) return
        sendUpdate(r, c, n)
      }
    </script>
  </body>
</html>
